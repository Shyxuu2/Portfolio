import{onValue as K,ref as W,getDatabase as X,push as q,set as Q}from"https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";import{initializeApp as Y}from"https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";import{getAnalytics as Z}from"https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";(function(){const u=document.createElement("link").relList;if(u&&u.supports&&u.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))p(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const g of i.addedNodes)g.tagName==="LINK"&&g.rel==="modulepreload"&&p(g)}).observe(document,{childList:!0,subtree:!0});function x(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function p(a){if(a.ep)return;a.ep=!0;const i=x(a);fetch(a.href,i)}})();document.addEventListener("DOMContentLoaded",()=>{const L="https://docs.google.com/spreadsheets/d/e/2PACX-1vT22H5wwzzf6X_cvbJlFMNkIVUQRKBjoJ1uGyNC-v-53emu-qR85Oux8uUJ8BAsklwclbmv2y-PGUjY/pub?output=csv",u=document.getElementById("ranks-grid"),x=document.getElementById("loading-indicator"),p=document.getElementById("playerModal");document.getElementById("modalContent");const a=document.getElementById("modalContentInner"),i=document.getElementById("loadingState"),g=document.getElementById("closeModalBtn"),k=document.getElementById("playerName"),b=document.getElementById("playerUUID"),h=document.getElementById("playerSkin"),R=document.getElementById("globalRank"),B=document.getElementById("tierRank"),y=document.getElementById("commentAuthor"),I=document.getElementById("commentInput"),S=document.getElementById("submitCommentBtn"),v=document.getElementById("commentsList"),M=document.getElementById("playerPoints");let f=null;async function P(){try{const e=`https://corsproxy.io/?${encodeURIComponent(L)}`,t=await fetch(e);if(!t.ok)throw new Error(`Network error: ${t.statusText}`);const n=await t.text(),s=j(n),o=U(s);A(o),_()}catch(e){console.error("Failed to load ranks:",e),u.innerHTML='<p class="text-red-400 text-center col-span-full">Error: Could not load data. Please check the Google Sheet URL and its sharing settings.</p>'}finally{x.style.display="none"}}function j(e){const t=e.trim().split(`
`),n=t[0].split(",").map(o=>o.trim()),s={};n.forEach(o=>s[o]=[]);for(let o=1;o<t.length;o++)t[o].split(",").map(c=>c.trim()).forEach((c,r)=>{c&&s[n[r]].push(c)});return s}const N={"Tier 1":{normal:45,special:60},"Tier 2":{normal:20,special:30},"Tier 3":{normal:6,special:10},"Tier 4":{normal:3,special:4},"Tier 5":{normal:1,special:2}};function U(e){const t={};let n=1;const s=Object.keys(e).sort((o,d)=>{const c=parseInt(o.match(/\d+/)||0),r=parseInt(d.match(/\d+/)||0);return c-r});for(const o of s){const c=e[o].map((r,m)=>{const l=r.startsWith("*")&&r.endsWith("*"),$=l?r.slice(1,-1):r,T=N[o],J=l?T.special:T.normal;return{originalName:r,cleanName:$,isSpecial:l,originalIndex:m,points:J}}).sort((r,m)=>r.isSpecial===m.isSpecial?r.originalIndex-m.originalIndex:m.isSpecial-r.isSpecial);t[o]=c.map((r,m)=>({...r,tierRank:m+1,globalRank:n++}))}return t}function A(e){u.innerHTML="";const t={"Tier 1":'<i class="fa-solid fa-trophy-star"></i>',"Tier 2":'<i class="fa-solid fa-trophy"></i>',"Tier 3":'<i class="fa-solid fa-trophy"></i>',"Tier 4":"","Tier 5":""};for(const n in e){const s=e[n],o=document.createElement("div");o.className="bg-gray-800 rounded-lg p-4 shadow-lg flex flex-col w-full";const d=t[n],c={"Tier 1":"text-[#c1c400]","Tier 2":"text-[#c7c7c7]","Tier 3":"text-[#bf6900]","Tier 4":"text-[#595959]","Tier 5":"text-[#ffffff]"},r=s.map(l=>`
                    <li class="player-item cursor-pointer text-white ${l.isSpecial?"bg-emerald-700":"bg-emerald-900"} border border-black/50 p-2 hover:translate-x-2 transition-transform duration-200 ease-in-out rounded-md flex items-center justify-start"
                        data-username="${l.cleanName}"
                        data-global-rank="${l.globalRank}"
                        data-tier-rank="${l.tierRank}"
                        data-tier-name="${n}"
                        data-points="${l.points}"
						data-isspecial="${l.isSpecial?"true":"false"}">
                        <span class="font-semibold">#${l.tierRank}</span>
                        <span class="ml-2">${l.cleanName}</span>
                        <img class="mx-[5px] flex justify-self-end ml-auto rounded-sm" src="https://mc-heads.net/avatar/${l.cleanName}/25"></img>
                    </li>
                    
                `).join(""),m=c[n]||"text-white";o.innerHTML=`
                <h2 class="text-2xl font-semibold border-b border-gray-700 pb-3 mb-4 flex items-center gap-3 ${m} huninn-regular">
                    ${d} ${n}
                </h2>

                <ul class="space-y-2">
                    ${r||'<li class="text-gray-500 italic">No players in this tier.</li>'}
                </ul>
`,u.appendChild(o)}}async function H(e){f=null,p.classList.add("active"),document.body.style.overflow="hidden",i.classList.remove("hidden"),a.classList.add("hidden"),R.textContent=`#${e.globalRank}`;const t=e.tierName.replace("Tier ",""),n=e.isSpecial?"H":"L";B.textContent=`${n}T${t}`,M.textContent=`${e.points} pts`,k.textContent=e.username,b.textContent="Loading...",h.src="";try{const s=await O(e.username);f=s,k.textContent=s.name,b.textContent=D(s.uuid);const o=`https://render.crafty.gg/3d/bust/${s.uuid}`;h.src=o,h.onerror=()=>{h.src=`https://crafatar.com/renders/body/${s.uuid}?overlay`},z()}catch(s){console.error("Failed to load player details:",s),b.textContent="Player not found"}finally{i.classList.add("hidden"),a.classList.remove("hidden")}}function E(){p.classList.remove("active"),document.body.style.overflow="",f=null}async function O(e){try{const n=`https://corsproxy.io/?${`https://api.mojang.com/users/profiles/minecraft/${e}`}`,s=await fetch(n);if(!s.ok)throw new Error("Player not found or API error");const o=await s.json();return{name:o.name,uuid:o.id}}catch(t){return console.warn("Mojang API failed, trying fallback. Error:",t),{name:e,uuid:"00000000-0000-0000-0000-000000000000"}}}function D(e){return!e||e.length!==32?e:e.replace(/(.{8})(.{4})(.{4})(.{4})(.{12})/,"$1-$2-$3-$4-$5")}function w(){return f?W(X(),`comments/${f.uuid}`):null}function z(){const e=w();if(!e){v.innerHTML='<p class="text-gray-500 text-center">Impossible de charger les commentaires.</p>';return}K(e,t=>{const n=t.val(),s=n?Object.values(n).sort((o,d)=>new Date(d.timestamp)-new Date(o.timestamp)):[];G(s)})}function F(e){const t=w();if(!t)return;const n=q(t);Q(n,e)}function G(e){if(e.length===0){v.innerHTML=`
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-comments text-3xl mb-2"></i>
                <p>Pas encore de commentaires. Soyez le premier !</p>
            </div>`;return}v.innerHTML=e.map(t=>`
        <div class="comment-item">
            <div class="comment-header">
                <span class="comment-author">${C(t.author)}</span>
                <span class="comment-time">${V(t.timestamp)}</span>
            </div>
            <p class="comment-text">${C(t.text)}</p>
        </div>
    `).join("")}S.addEventListener("click",()=>{if(!f){alert("Impossible de publier un commentaire : données joueur non chargées.");return}const e=y.value.trim(),t=I.value.trim();if(!e||!t){alert("Veuillez entrer votre nom et un commentaire.");return}const n={author:e,text:t,timestamp:new Date().toISOString()};F(n),I.value="",I.focus()});function C(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function V(e){const t=new Date(e),s=new Date-t,o=Math.floor(s/1e3),d=Math.floor(o/60),c=Math.floor(d/60),r=Math.floor(c/24);return o<60?"À l’instant":d<60?`${d} min`:c<24?`${c} h`:r<7?`${r} j`:t.toLocaleDateString()}function _(){u.addEventListener("click",t=>{const n=t.target.closest(".player-item");if(n){const s={username:n.dataset.username,globalRank:n.dataset.globalRank,tierRank:n.dataset.tierRank,tierName:n.dataset.tierName,points:n.dataset.points,isSpecial:n.dataset.isspecial==="true"};H(s)}}),g.addEventListener("click",E),p.addEventListener("click",t=>{t.target===p&&E()}),document.addEventListener("keydown",t=>{t.key==="Escape"&&p.classList.contains("active")&&E()});const e=localStorage.getItem("comment_author");e&&(y.value=e),y.addEventListener("blur",()=>{localStorage.setItem("comment_author",y.value.trim())})}P()});const ee={apiKey:"AIzaSyA5Mj4jXLH3x43HF6BAn9Z7RwVgFWPgn1I",authDomain:"franceclutchs.firebaseapp.com",databaseURL:"https://franceclutchs-default-rtdb.europe-west1.firebasedatabase.app",projectId:"franceclutchs",storageBucket:"franceclutchs.firebasestorage.app",messagingSenderId:"463129204581",appId:"1:463129204581:web:e53c5505f9510a088af38c",measurementId:"G-D6KQBJBYN6"},te=Y(ee);Z(te);
